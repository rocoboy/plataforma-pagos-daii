openapi: 3.1.0
info:
  title: Payments API
  version: "1.0.0"
  description: |
    API del **módulo de pagos** (Next.js + Supabase).
    - Persiste y gestiona pagos en la tabla `payments`.
    - Expone endpoints para crear, actualizar, listar, obtener por ID y listar por usuario.
    - Incluye **esquemas de eventos** que el módulo publica/recibe.
    - Actualizado: se permite **cancelar** (`CANCELLED`), **reembolsar** (`REFUNDED`) y **rechazar** (`DECLINED`) pagos.
servers:
  - url: https://plataforma-pagos-daii.vercel.app/
    description: Servidor de producción (Vercel)
  - url: https://plataforma-pagos-daii-gim326dta-uades-projects.vercel.app/
    description: Preproducción / deployment de proyecto

tags:
  - name: Payments
    description: Operaciones sobre pagos
  - name: Payment Events
    description: Esquemas de eventos publicados/consumidos por el módulo
  - name: Webhooks
    description: Webhooks para integración con pasarelas externas

paths:
  /payments:
    post:
      tags: [Payments]
      summary: Crear un pago
      description: Crea un pago con estado inicial `PENDING` (por defecto) y moneda `ARS` si no se especifica.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreatePaymentRequest'
            examples:
              crearPago:
                value:
                  res_id: "15"
                  user_id: "5"
                  amount: 20000
                  currency: ARS
                  meta:
                    origen: "web"
      responses:
        "200":
          description: Creado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreatePaymentResponse'
        "400":
          description: Body inválido (zod validation error)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationErrorResponse'
        "500":
          description: Error interno
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    put:
      tags: [Payments]
      summary: Actualizar estado de un pago
      description: Actualiza el `status` de un pago existente y retorna el registro actualizado.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdatePaymentRequest'
            examples:
              aprobarPago:
                value:
                  id: "32"
                  status: SUCCESS
              rechazarPago:
                value:
                  id: "33"
                  status: DECLINED
              cancelarPago:
                value:
                  id: "34"
                  status: CANCELLED
              reembolsarPago:
                value:
                  id: "35"
                  status: REFUNDED
      responses:
        "200":
          description: Actualizado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UpdatePaymentResponse'
        "400":
          description: Body inválido (zod validation error)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationErrorResponse'
        "500":
          description: Error interno
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    get:
      tags: [Payments]
      summary: Listar todos los pagos
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListPaymentsResponse'
        "500":
          description: Error interno
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /payments/{id}:
    get:
      tags: [Payments]
      summary: Obtener un pago por ID
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GetPaymentResponse'
        "400":
          description: Parámetro inválido (zod validation error)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationErrorResponse'
        "500":
          description: Error interno
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /payments/by-user:
    get:
      tags: [Payments]
      summary: Listar pagos por usuario
      description: |
        Devuelve los pagos filtrados por `user_id`.
        **Nota:** El handler actual de Next.js puede leer el `user_id` desde el **cuerpo** de la petición `GET` (no estándar).
        - OpenAPI 3.1 permite `requestBody` en GET, por compatibilidad se documentan **ambas** opciones:
          1) `user_id` como **query param** (recomendado)
          2) `user_id` en **requestBody** (compatibilidad con el código actual)
      parameters:
        - name: user_id
          in: query
          required: false
          schema:
            type: string
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GetUserPaymentsRequest'
            examples:
              bodyGET:
                value:
                  user_id: "5"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GetUserPaymentsResponse'
        "400":
          description: Body/params inválidos (zod validation error)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationErrorResponse'
        "500":
          description: Error interno
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /webhooks/payments:
    post:
      tags: [Webhooks]
      summary: Webhook de creación de pago
      description: |
        Recibe el evento `payment.created` desde una pasarela y crea un pago.
        El payload viene en formato **envelope + data** (data = CreatePaymentRequest).
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WebhookPaymentCreated'
            examples:
              ejemplo:
                value:
                  id: "evt_01JABCXYZ"
                  type: "payment.created"
                  ts: "2025-09-18T15:03:33Z"
                  signature: "sha256=6b9a..."
                  data:
                    res_id: "15"
                    user_id: "5"
                    amount: 20000
                    currency: ARS
                    meta:
                      origen: "web"
      responses:
        "202":
          description: Evento aceptado para procesamiento
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiBase'
        "400":
          description: Body inválido (validación)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationErrorResponse'
        "500":
          description: Error interno
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    put:
      tags: [Webhooks]
      summary: Webhook de actualización de pago
      description: |
        Recibe el evento `payment.updated` para actualizar el estado de un pago.
        Soporta **SUCCESS**, **DECLINED**, **CANCELLED** y **REFUNDED**.
        El payload viene en formato **envelope + data** (data = UpdatePaymentRequest).
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WebhookPaymentUpdated'
            examples:
              aprobado:
                value:
                  id: "evt_01JABCUVW"
                  type: "payment.updated"
                  ts: "2025-09-18T15:05:00Z"
                  signature: "sha256=92ac..."
                  data:
                    id: "32"
                    status: SUCCESS
              rechazado:
                value:
                  id: "evt_01JABCUVW"
                  type: "payment.updated"
                  ts: "2025-09-18T15:05:30Z"
                  signature: "sha256=c0de..."
                  data:
                    id: "33"
                    status: DECLINED
              cancelado:
                value:
                  id: "evt_01JABCUVW"
                  type: "payment.updated"
                  ts: "2025-09-18T15:06:00Z"
                  signature: "sha256=3fd1..."
                  data:
                    id: "34"
                    status: CANCELLED
              reembolsado:
                value:
                  id: "evt_01JABCUVW"
                  type: "payment.updated"
                  ts: "2025-09-18T15:07:00Z"
                  signature: "sha256=af71..."
                  data:
                    id: "35"
                    status: REFUNDED
      responses:
        "202":
          description: Evento aceptado para procesamiento
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiBase'
        "400":
          description: Body inválido (validación)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationErrorResponse'
        "422":
          description: Estado no permitido por el enum
        "500":
          description: Error interno
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  schemas:
    Payment:
      type: object
      properties:
        id:
          type: string
          description: Identificador del pago (UUID o string de base de datos)
        res_id:
          type: string
          description: Identificador de la reserva asociada (en otros sistemas puede llamarse reservationId)
        user_id:
          type: string
          nullable: true
        amount:
          type: number
          format: double
        currency:
          $ref: '#/components/schemas/Currency'
        status:
          $ref: '#/components/schemas/PaymentStatus'
        meta:
          description: Datos arbitrarios asociados al pago
          oneOf:
            - type: object
            - type: array
            - type: string
            - type: number
            - type: boolean
            - type: 'null'
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
      required: [id, res_id, amount, status]
      example:
        id: "32"
        res_id: "15"
        user_id: "5"
        amount: 20000
        currency: ARS
        status: PENDING
        meta:
          origen: "web"
          paymentEventId: 32
        created_at: "2025-09-10T12:00:00Z"
        updated_at: "2025-09-10T12:00:00Z"

    PaymentStatus:
      type: string
      description: |
        Enum **Supabase** `payment_status`.
        Valores soportados:
        - `PENDING`: pago iniciado, en proceso.
        - `SUCCESS`: pago confirmado/aprobado.
        - `DECLINED`: pago rechazado.
        - `CANCELLED`: pago cancelado por el usuario o por el sistema.
        - `REFUNDED`: pago reembolsado (monto devuelto).
        - `REFUND`: **alias histórico** (compatibilidad). Se recomienda `REFUNDED`.
      enum: [PENDING, SUCCESS, REFUND, DECLINED, CANCELLED, REFUNDED]
      example: PENDING

    Currency:
      type: string
      description: Enum Supabase `currency`.
      enum: [ARS, USD]
      example: ARS

    CreatePaymentRequest:
      type: object
      properties:
        res_id:
          type: string
        user_id:
          type: string
          nullable: true
        amount:
          type: number
          format: double
        currency:
          $ref: '#/components/schemas/Currency'
        meta:
          description: Cualquier payload adicional
          oneOf:
            - type: object
            - type: array
            - type: string
            - type: number
            - type: boolean
            - type: 'null'
      required: [res_id, amount]

    UpdatePaymentRequest:
      type: object
      properties:
        id:
          type: string
        status:
          $ref: '#/components/schemas/PaymentStatus'
      required: [id, status]

    GetUserPaymentsRequest:
      type: object
      properties:
        user_id:
          type: string
      required: [user_id]

    ApiBase:
      type: object
      properties:
        success:
          type: boolean
          example: true

    ErrorResponse:
      allOf:
        - $ref: '#/components/schemas/ApiBase'
        - type: object
          properties:
            error:
              type: string
              example: Unknown error

    ValidationErrorResponse:
      allOf:
        - $ref: '#/components/schemas/ApiBase'
        - type: object
          properties:
            error:
              type: string
              example: Invalid request body
            issues:
              type: string
              description: Mensaje de error generado por Zod

    CreatePaymentResponse:
      allOf:
        - $ref: '#/components/schemas/ApiBase'
        - type: object
          properties:
            payment:
              $ref: '#/components/schemas/Payment'

    UpdatePaymentResponse:
      allOf:
        - $ref: '#/components/schemas/ApiBase'
        - type: object
          properties:
            payment:
              $ref: '#/components/schemas/Payment'

    GetPaymentResponse:
      allOf:
        - $ref: '#/components/schemas/ApiBase'
        - type: object
          properties:
            payment:
              $ref: '#/components/schemas/Payment'

    ListPaymentsResponse:
      allOf:
        - $ref: '#/components/schemas/ApiBase'
        - type: object
          properties:
            payments:
              type: array
              items:
                $ref: '#/components/schemas/Payment'

    GetUserPaymentsResponse:
      allOf:
        - $ref: '#/components/schemas/ApiBase'
        - type: object
          properties:
            payments:
              type: array
              items:
                $ref: '#/components/schemas/Payment'

    PaymentEvent:
      type: object
      properties:
        paymentEventId:
          type: integer
        paymentStatus:
          $ref: '#/components/schemas/PaymentStatus'
        amount:
          type: number
          format: double
        reservationId:
          type: integer
        userID:
          type: integer
      required: [paymentEventId, paymentStatus, reservationId, userID]
      example:
        paymentEventId: 123
        paymentStatus: PENDING
        amount: 100.0
        reservationId: 11
        userID: 1

    ConfirmedPaymentMessage:
      type: object
      properties:
        paymentStatus:
          $ref: '#/components/schemas/PaymentStatus'
        reservationId:
          type: integer
        userID:
          type: integer
        paymentEventId:
          type: integer
      required: [paymentStatus, reservationId, userID, paymentEventId]
      example:
        paymentStatus: SUCCESS
        reservationId: 15
        userID: 5
        paymentEventId: 12

    RefundMessage:
      type: object
      properties:
        paymentEventId:
          type: integer
        paymentStatus:
          $ref: '#/components/schemas/PaymentStatus'
        reservationId:
          type: integer
        userID:
          type: integer
      required: [paymentEventId, paymentStatus, reservationId, userID]
      example:
        paymentEventId: 56
        paymentStatus: REFUNDED
        reservationId: 11
        userID: 1

    WebhookEnvelopeBase:
      type: object
      description: Envelope del webhook (estilo CloudEvents simplificado)
      properties:
        id:
          type: string
          description: ID del evento
        type:
          type: string
          description: Tipo de evento (p.ej. payment.created, payment.updated)
        ts:
          type: string
          format: date-time
          description: Fecha/hora del evento
        signature:
          type: string
          description: Firma HMAC (sha256=...) para verificar integridad
      required: [id, type, ts]

    WebhookPaymentCreated:
      allOf:
        - $ref: '#/components/schemas/WebhookEnvelopeBase'
        - type: object
          properties:
            type:
              type: string
              enum: [payment.created]
            data:
              $ref: '#/components/schemas/CreatePaymentRequest'
          required: [data]

    WebhookPaymentUpdated:
      allOf:
        - $ref: '#/components/schemas/WebhookEnvelopeBase'
        - type: object
          properties:
            type:
              type: string
              enum: [payment.updated]
            data:
              $ref: '#/components/schemas/UpdatePaymentRequest'
          required: [data]
