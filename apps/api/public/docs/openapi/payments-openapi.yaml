openapi: 3.1.0
info:
  title: Payments API
  version: "1.0.0"
  description: |
    API del **módulo de pagos** (Next.js + Supabase).
    - Persiste y gestiona pagos en la tabla `payments`.
    - Expone endpoints para crear, actualizar, listar, obtener por ID y listar por usuario.
    - Incluye **esquemas de eventos** que el módulo publica/recibe
servers:
  - url: https://plataforma-pagos-daii.vercel.app/api
    description: Servidor de producción (Vercel)
tags:
  - name: Payments
    description: Operaciones sobre pagos
  - name: Users
    description: Operaciones sobre usuarios
  - name: Webhooks
    description: Webhooks para integración

paths:
  /payments:
    get:
      tags: [Payments]
      summary: Listar todos los pagos
      description: Obtiene todos los pagos de la base de datos
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListPaymentsResponse'
        "500":
          description: Error interno
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /payments/{id}:
    get:
      tags: [Payments]
      summary: Obtener un pago por ID
      description: Obtiene un pago específico por su ID
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          description: ID del pago
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GetPaymentResponse'
        "400":
          description: Parámetro inválido
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationErrorResponse'
        "500":
          description: Error interno
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /users:
    get:
      tags: [Users]
      summary: Listar pagos por usuario
      description: Obtiene los pagos filtrados por user_id
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GetUserPaymentsRequest'
            examples:
              userPayments:
                value:
                  user_id: "5"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GetUserPaymentsResponse'
        "400":
          description: Body inválido
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationErrorResponse'
        "500":
          description: Error interno
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /webhooks/payments:
    post:
      tags: [Webhooks]
      summary: Crear un pago
      description: Crea un pago con estado inicial `PENDING` (por defecto) y moneda `ARS` si no se especifica.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreatePaymentRequest'
            examples:
              crearPago:
                value:
                  res_id: "15"
                  user_id: "5"
                  amount: 20000
                  currency: "ARS"
                  meta:
                    origen: "web"
      responses:
        "200":
          description: Creado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreatePaymentResponse'
        "400":
          description: Body inválido (zod validation error)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationErrorResponse'
        "500":
          description: Error interno
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    put:
      tags: [Webhooks]
      summary: Actualizar estado de un pago
      description: Actualiza el `status` de un pago existente y retorna el registro actualizado.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdatePaymentRequest'
            examples:
              aprobarPago:
                value:
                  id: "32"
                  status: "SUCCESS"
              rechazarPago:
                value:
                  id: "33"
                  status: "DECLINED"
      responses:
        "200":
          description: Actualizado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UpdatePaymentResponse'
        "400":
          description: Body inválido (zod validation error)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationErrorResponse'
        "500":
          description: Error interno
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  schemas:
    Payment:
      type: object
      properties:
        id:
          type: string
          description: Identificador del pago (UUID o string de base de datos)
        res_id:
          type: string
          description: Identificador de la reserva asociada
        user_id:
          type: string
          nullable: true
          description: ID del usuario
        amount:
          type: number
          format: double
          description: Monto del pago
        currency:
          $ref: '#/components/schemas/Currency'
        status:
          $ref: '#/components/schemas/PaymentStatus'
        meta:
          description: Datos arbitrarios asociados al pago
          oneOf:
            - type: object
            - type: array
            - type: string
            - type: number
            - type: boolean
            - type: 'null'
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
      required: [id, res_id, amount, status]
      example:
        id: "32"
        res_id: "15"
        user_id: "5"
        amount: 20000
        currency: "ARS"
        status: "PENDING"
        meta:
          origen: "web"
        created_at: "2024-01-15T10:30:00Z"
        updated_at: "2024-01-15T10:30:00Z"

    PaymentStatus:
      type: string
      description: |
        Enum **Supabase** `payment_status`.
        Valores comunes en los flujos funcionales: `PENDING`, `SUCCESS`, `REFUND`, `DECLINED`.
      enum: ["PENDING", "SUCCESS", "REFUND", "DECLINED"]
      example: "PENDING"

    Currency:
      type: string
      description: Enum Supabase `currency`.
      enum: ["ARS", "USD"]
      example: "ARS"

    CreatePaymentRequest:
      type: object
      properties:
        res_id:
          type: string
        user_id:
          type: string
          nullable: true
        amount:
          type: number
          format: double
        currency:
          $ref: '#/components/schemas/Currency'
        meta:
          description: Cualquier payload adicional
          oneOf:
            - type: object
            - type: array
            - type: string
            - type: number
            - type: boolean
            - type: 'null'
      required: [res_id, amount]

    UpdatePaymentRequest:
      type: object
      properties:
        id:
          type: string
        status:
          $ref: '#/components/schemas/PaymentStatus'
      required: [id, status]

    GetUserPaymentsRequest:
      type: object
      properties:
        user_id:
          type: string
      required: [user_id]

    ApiBase:
      type: object
      properties:
        success:
          type: boolean
          example: true

    ErrorResponse:
      allOf:
        - $ref: '#/components/schemas/ApiBase'
        - type: object
          properties:
            error:
              type: string
              example: "Unknown error"

    ValidationErrorResponse:
      allOf:
        - $ref: '#/components/schemas/ApiBase'
        - type: object
          properties:
            error:
              type: string
              example: "Invalid request body"
            issues:
              type: string
              description: Mensaje de error generado por Zod

    CreatePaymentResponse:
      allOf:
        - $ref: '#/components/schemas/ApiBase'
        - type: object
          properties:
            payment:
              $ref: '#/components/schemas/Payment'

    UpdatePaymentResponse:
      allOf:
        - $ref: '#/components/schemas/ApiBase'
        - type: object
          properties:
            payment:
              $ref: '#/components/schemas/Payment'

    GetPaymentResponse:
      allOf:
        - $ref: '#/components/schemas/ApiBase'
        - type: object
          properties:
            payment:
              $ref: '#/components/schemas/Payment'

    ListPaymentsResponse:
      allOf:
        - $ref: '#/components/schemas/ApiBase'
        - type: object
          properties:
            payments:
              type: array
              items:
                $ref: '#/components/schemas/Payment'

    GetUserPaymentsResponse:
      allOf:
        - $ref: '#/components/schemas/ApiBase'
        - type: object
          properties:
            payments:
              type: array
              items:
                $ref: '#/components/schemas/Payment'