openapi: 3.1.0
info:
  title: Payments API
  version: "1.0.0"
  description: |
    API del **módulo de pagos** (Next.js + Supabase).
    - Persiste y gestiona pagos en la tabla `payments`.
    - Expone endpoints para crear, actualizar, listar, obtener por ID y listar por usuario.
    - Incluye **esquemas de eventos** que el módulo publica/recibe.
servers:
  - url: https://plataforma-pagos-daii.vercel.app
    description: Servidor de producción (Vercel)
  - url: https://plataforma-pagos-daii-preprod.vercel.app
    description: Preproducción / deployment de proyecto

tags:
  - name: Payments
    description: Operaciones sobre pagos (Admin/Internos)
  - name: Webhooks
    description: Webhooks para integración con sistemas externos (Kafka Bridge, Pasarelas)
  - name: Payment Events
    description: Esquemas de eventos publicados/consumidos por el módulo

paths:
  /api/payments:
    post:
      tags: [Payments]
      summary: Crear un pago
      description: Crea un pago con estado inicial `PENDING` (por defecto) y moneda `ARS` si no se especifica.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreatePaymentRequest'
            examples:
              crearPago:
                value:
                  res_id: "15"
                  user_id: "5"
                  amount: 20000
                  currency: ARS
                  meta:
                    origen: "web"
      responses:
        "200":
          description: Creado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreatePaymentResponse'
        "400":
          description: Body inválido (zod validation error)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationErrorResponse'
        "500":
          description: Error interno
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    put:
      tags: [Payments]
      summary: Actualizar estado de un pago (por ID)
      description: Actualiza el `status` de un pago existente (buscando por 'id') y retorna el registro actualizado.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdatePaymentRequest'
            examples:
              aprobarPago:
                value:
                  id: "32a-uuid-..."
                  status: SUCCESS
      responses:
        "200":
          description: Actualizado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UpdatePaymentResponse'
        "400":
          description: Body inválido (zod validation error)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationErrorResponse'
        "500":
          description: Error interno
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    get:
      tags: [Payments]
      summary: Listar todos los pagos
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListPaymentsResponse'
        "500":
          description: Error interno
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/payments/{id}:
    get:
      tags: [Payments]
      summary: Obtener un pago por ID
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GetPaymentResponse'
        "400":
          description: Parámetro inválido (zod validation error)
        "500":
          description: Error interno

  /api/payments/by-user:
    get:
      tags: [Payments]
      summary: Listar pagos por usuario
      parameters:
        - name: user_id
          in: query
          required: true
          schema:
            type: string
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GetUserPaymentsResponse'
        "400":
          description: Body/params inválidos (zod validation error)
        "500":
          description: Error interno

  /api/webhooks/payments:
    post:
      tags: [Webhooks]
      summary: Webhook de creación de pago (Kafka Bridge)
      description: |
        Recibe el evento `reservations.reservation.created` desde el bridge de Kafka.
        El payload es el body de la API de creación de pago (ya espera res_id).
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreatePaymentRequest'
      responses:
        "200":
          description: Pago creado o duplicado detectado (Idempotencia)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreatePaymentResponse'
        "400":
          description: Body inválido (Zod)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationErrorResponse'
        "500":
          description: Error interno (RLS, Supabase, etc.)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    put:
      tags: [Webhooks]
      summary: Webhook de actualización de pago (Kafka Bridge)
      description: |
        Recibe el evento `reservations.reservation.updated` desde el bridge de Kafka.
        Usa res_id para encontrar y actualizar el pago.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WebhookUpdatePaymentRequest'
            examples:
              aprobado:
                value:
                  res_id: "210"
                  status: SUCCESS
              reembolsado:
                value:
                  res_id: "211"
                  status: REFUND
      responses:
        "200":
          description: Actualizado (o ignorado si no se encontró)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UpdatePaymentResponse'
        "400":
          description: Body inválido (Zod)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationErrorResponse'
        "500":
          description: Error interno (RLS, Supabase, etc.)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  schemas:
    Payment:
      type: object
      properties:
        id:
          type: string
          description: Identificador del pago (UUID o string de base de datos)
        res_id:
          type: string
          description: Identificador de la reserva asociada (en otros sistemas puede llamarse reservationId)
        user_id:
          type: string
          nullable: true
        amount:
          type: number
          format: double
        currency:
          $ref: '#/components/schemas/Currency'
        status:
          $ref: '#/components/schemas/PaymentStatus'
        meta:
          description: Datos arbitrarios asociados al pago
          oneOf:
            - type: object
            - type: array
            - type: string
            - type: number
            - type: boolean
            - type: 'null'
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
      required: [id, res_id, amount, status]
      example:
        id: "32"
        res_id: "15"
        user_id: "5"
        amount: 20000
        currency: ARS
        status: PENDING
        meta:
          origen: "web"
          paymentEventId: 32
        created_at: "2025-09-10T12:00:00Z"
        updated_at: "2025-09-10T12:00:00Z"

    PaymentStatus:
      type: string
      description: |
        Enum **Supabase** `payment_status`. Sincronizado con la base de datos.
      # ESTA es la lista correcta
      enum: [PENDING, SUCCESS, FAILURE, UNDERPAID, OVERPAID, EXPIRED, REFUND]
      example: PENDING

    Currency:
      type: string
      description: Enum Supabase `currency`.
      enum: [ARS, USD, EUR] # (Agregué EUR que vi en tus logs)
      example: ARS

    CreatePaymentRequest:
      type: object
      properties:
        res_id:
          type: string
        user_id:
          type: string
          nullable: true
        amount:
          type: number
          format: double
        currency:
          $ref: '#/components/schemas/Currency'
        meta:
          description: Cualquier payload adicional
          oneOf:
            - type: object
            - type: array
            - type: string
            - type: number
            - type: boolean
            - type: 'null'
      required: [res_id, amount]

    UpdatePaymentRequest:
      type: object
      description: (ADMIN) Actualiza un pago usando su ID primario (UUID)
      properties:
        id:
          type: string
          format: uuid
        status:
          $ref: '#/components/schemas/PaymentStatus'
      required: [id, status]

    WebhookUpdatePaymentRequest:
      type: object
      description: (WEBHOOK) Actualiza un pago usando el ID de reserva (res_id)
      properties:
        res_id:
          type: string
          description: El ID de la reserva (reservationId)
        status:
          $ref: '#/components/schemas/PaymentStatus'
      required: [res_id, status]

    GetUserPaymentsRequest:
      type: object
      properties:
        user_id:
          type: string
      required: [user_id]

    ApiBase:
      type: object
      properties:
        success:
          type: boolean
          example: true

    ErrorResponse:
      allOf:
        - $ref: '#/components/schemas/ApiBase'
        - type: object
          properties:
            error:
              type: string
              example: Unknown error

    ValidationErrorResponse:
      allOf:
        - $ref: '#/components/schemas/ApiBase'
        - type: object
          properties:
            error:
              type: string
              example: Invalid request body
            issues:
              type: string
              description: Mensaje de error generado por Zod

    CreatePaymentResponse:
      allOf:
        - $ref: '#/components/schemas/ApiBase'
        - type: object
          properties:
            payment:
              $ref: '#/components/schemas/Payment'

    UpdatePaymentResponse:
      allOf:
        - $ref: '#/components/schemas/ApiBase'
        - type: object
          properties:
            payment:
              oneOf:
                - $ref: '#/components/schemas/Payment'
                - type: 'null'

    GetPaymentResponse:
      allOf:
        - $ref: '#/components/schemas/ApiBase'
        - type: object
          properties:
            payment:
              $ref: '#/components/schemas/Payment'

    ListPaymentsResponse:
      allOf:
        - $ref: '#/components/schemas/ApiBase'
        - type: object
          properties:
            payments:
              type: array
              items:
                $ref: '#/components/schemas/Payment'

    GetUserPaymentsResponse:
      allOf:
        - $ref: '#/components/schemas/ApiBase'
        - type: object
          properties:
            payments:
              type: array
              items:
                $ref: '#/components/schemas/Payment'
    
 